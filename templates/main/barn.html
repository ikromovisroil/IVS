{% extends 'base.html' %}
{% load static %}

{% block title %}
<title>Tashkilot texnikalari</title>
{% endblock title %}

{% block content %}

<main id="main" class="main">

    <div class="pagetitle">
        <h1>Texnika va materiallar</h1>
    </div>

    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
                <form class="row g-2 mt-1" method="get">
                    <div class="col-md-3">
                        <label for="status" class="form-label">Xolati</label>
                        <select id="status" name="status" class="form-select">
                          <option value="">Tanlang...</option>
                          <option value="active" {% if request.GET.status == "active" %}selected{% endif %}>Aktiv</option>
                          <option value="free"   {% if request.GET.status == "free" %}selected{% endif %}>Bo'sh</option>
                          <option value="repair" {% if request.GET.status == "repair" %}selected{% endif %}>Ta’mirda</option>
                          <option value="defect" {% if request.GET.status == "defect" %}selected{% endif %}>Brak</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="employee" class="form-label">Xodim</label>
                        <select id="employee" name="employee" class="form-select">
                          <option value="">Tanlang...</option>
                          {% for emp in employees_boss %}
                            <option value="{{ emp.id }}"
                              {% if request.GET.employee|stringformat:"s" == emp.id|stringformat:"s" %}selected{% endif %}>
                              {{ emp.last_name }} {{ emp.first_name }} {{ emp.father_name }}
                            </option>
                          {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Qidirish</button>
                    </div>
                </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TEXNIKALAR -->
    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                 <h5 class="card-title">Texnikalar</h5>
                 <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#verticalycentered">
                   Texnika qo'shish
                 </button>
              </div>

              <table class="table datatable">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Nomi</th>
                    <th scope="col">I/N</th>
                    <th scope="col">S/N</th>
                    <th scope="col">Yili</th>
                  </tr>
                </thead>
                <tbody id="technicsBody">
                {% for tex in technics %}
                  <tr>
                    <th scope="row">{{ forloop.counter }}</th>
                    <td>({{tex.category.name|default:"-"}}) {{tex.name|default:"-"}}</td>
                    <td>{{tex.inventory|default:"-"}}</td>
                    <td>{{tex.serial|default:"-"}}</td>
                    <td>{{tex.year|default:"-"}}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>

            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TEXNIKA CREATE MODAL -->
    <div class="modal fade" id="verticalycentered" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <form class="modal-content" method="post" action="{% url 'technics_create' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Texnika qo‘shish</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Kategoriya</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.category }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Tashkilot</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.organization }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Xodim</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.employee }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Xolati</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.status }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Nomi</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.name }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Parametr</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.parametr }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Inventar</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.inventory }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Serial</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.serial }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Mac</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.mac }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Ip</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.ip }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Yil</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.year }}
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Narxi</label>
              <div class="col-md-8 col-lg-9">
                {{ technics_form.price }}
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary">Saqlash</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MATERIAL -->
    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                 <h5 class="card-title">Material</h5>
                 <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vertical">
                   Material qo'shish
                 </button>
              </div>

              <table class="table datatable">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Material Nomi</th>
                    <th scope="col">Soni</th>
                    <th scope="col">Narxi</th>
                    <th scope="col">Qiymati</th>
                    <th scope="col">1C code</th>
                    <th scope="col">Tafsif</th>
                  </tr>
                </thead>

                <tbody id="materialBody">
                {% for mat in material %}
                  <tr>
                    <th scope="row">{{ forloop.counter }}</th>
                    <td>{{ mat.name|default:"-"|truncatechars:50 }}</td>
                    <td>{{ mat.number|default:"-" }}</td>
                    <td>{{ mat.price|default:"-" }}</td>
                    <td>{{ mat.unit|default:"-" }}</td>
                    <td>{{ mat.code|default:"-" }}</td>
                    <td>
                      <div class="filter">
                        <a class="icon" href="javascript:void(0)" data-bs-toggle="dropdown">
                          <i class="bi bi-front" style="font-size: 18px;"></i>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                          <li>
                            <a class="dropdown-item"
                               href="javascript:void(0)"
                               data-bs-toggle="modal"
                               data-bs-target="#matdel-{{ mat.id }}">
                              <i class="bi bi-trash"></i> O'chirish
                            </a>
                          </li>
                          <li>
                            <a class="dropdown-item"
                               href="javascript:void(0)"
                               data-bs-toggle="modal"
                               data-bs-target="#mattax-{{ mat.id }}">
                              <i class="bi bi-brush"></i> Tahrirlash
                            </a>
                          </li>
                          <li>
                            <a class="dropdown-item"
                               href="javascript:void(0)"
                               data-bs-toggle="modal"
                               data-bs-target="#matbir-{{ mat.id }}">
                              <i class="bi bi-paperclip"></i> Biriktirish
                            </a>
                          </li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>

            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- MATERIAL CREATE MODAL -->
    <div class="modal fade" id="vertical" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <form class="modal-content" method="post" action="{% url 'material_create' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Material qo‘shish</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Nomi</label>
              <div class="col-md-8 col-lg-9">
                {{ material_form.name }}
              </div>
            </div>
            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">1C code</label>
              <div class="col-md-8 col-lg-9">
                {{ material_form.code }}
              </div>
            </div>
            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Soni</label>
              <div class="col-md-8 col-lg-9">
                {{ material_form.number }}
              </div>
            </div>
            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Birligi</label>
              <div class="col-md-8 col-lg-9">
                {{ material_form.unit }}
              </div>
            </div>
            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Narxi</label>
              <div class="col-md-8 col-lg-9">
                {{ material_form.price }}
              </div>
            </div>
            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Yil</label>
              <div class="col-md-8 col-lg-9">
                {{ material_form.year }}
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary">Saqlash</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ✅ MATERIAL EDIT MODALS (JADVALDAN TASHQARIDA!) -->
    {% for mat in material %}
    <div class="modal fade" id="matdel-{{ mat.id }}" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <form method="post" class="modal-content" action="{% url 'material_delete' %}">
          {% csrf_token %}

          <div class="modal-header">
            <h5 class="modal-title">Materialni o'chirish</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" name="material_id" value="{{ mat.id }}">

            <div class="mb-3">
              <label class="form-label">Nomi</label>
              <input type="text" class="form-control" value="{{ mat.name }}" disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">Mavjud soni</label>
              <input type="number" class="form-control" value="{{ mat.number }}" disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">Narxi</label>
              <input type="number" step="0.01" name="price"
                     class="form-control"
                     value="{{ mat.price|default_if_none:''|stringformat:'s'|cut:',' }}" disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">Birligi</label>
              <input type="text" class="form-control" value="{{ mat.unit|default_if_none:'' }}" disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">1C code</label>
              <input type="text" class="form-control" value="{{ mat.code|default_if_none:'' }}" disabled>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary">O'chirish</button>
          </div>

        </form>
      </div>
    </div>

    <div class="modal fade" id="matbir-{{ mat.id }}" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <form method="post" class="modal-content" action="{% url 'material_attach' %}">
          {% csrf_token %}

          <div class="modal-header">
            <h5 class="modal-title">Materialni biriktirish</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" name="material_id" value="{{ mat.id }}">

            <div class="mb-3">
              <label class="form-label">Nomi</label>
              <input type="text" class="form-control" value="{{ mat.name }}" disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">Mavjud soni</label>
              <input type="number" class="form-control" value="{{ mat.number }}" disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">Narxi</label>
              <input type="number" step="0.01" name="price"
                     class="form-control"
                     value="{{ mat.price|default_if_none:''|stringformat:'s'|cut:',' }}" disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">Birligi</label>
              <input type="text" class="form-control" value="{{ mat.unit|default_if_none:'' }}" disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">1C code</label>
              <input type="text" class="form-control" value="{{ mat.code|default_if_none:'' }}" disabled>
            </div>

            <div class="mb-3">
              <label class="form-label">Xodim</label>
              <select name="employee_id" class="form-select" required>
                <option value="">— Xodimni tanlang —</option>
                {% for emp in employees_boss %}
                  <option value="{{ emp.id }}">
                    {{ emp.last_name }} {{ emp.first_name }} {{ emp.father_name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Beriladigan soni</label>
              <input type="number" name="give_number" class="form-control" min="1" max="{{ mat.number }}" required>
            </div>

          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary">Biriktirish</button>
          </div>

        </form>
      </div>
    </div>

    <div class="modal fade" id="mattax-{{ mat.id }}" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <form method="post" class="modal-content" action="{% url 'material_update' mat.id %}">
          {% csrf_token %}

          <div class="modal-header">
            <h5 class="modal-title">Materialni tahrirlash</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Nomi</label>
              <input type="text" name="name" class="form-control" value="{{ mat.name }}" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Soni</label>
              <input type="number" name="number" class="form-control" value="{{ mat.number }}" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Narxi</label>
              <input type="number" step="0.01" name="price" class="form-control"  value="{{ mat.price|default_if_none:''|stringformat:'s'|cut:',' }}">
            </div>

            <div class="mb-3">
              <label class="form-label">Birligi</label>
              <input type="text" name="unit" class="form-control"  value="{{ mat.unit|default_if_none:'' }}">
            </div>

            <div class="mb-3">
              <label class="form-label">1C kodi</label>
              <input type="text" name="code" class="form-control" value="{{ mat.code }}">
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary">Saqlash</button>
          </div>
        </form>
      </div>
    </div>
    {% endfor %}

</main>

{% endblock content %}
