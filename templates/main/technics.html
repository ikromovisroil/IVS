{% extends 'base.html' %}
{% load static %}

{% block title %}
  <title>Texnikalar</title>
{% endblock title %}

{% block content %}

<main id="main" class="main">

  <div class="pagetitle">
    <h1>Texnikalar ro'yxati</h1>
  </div>

  <!-- FILTER -->
  <section class="section">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <form class="row g-2 mt-1" method="get">

              <div class="col-md-3">
                <label for="organization" class="form-label">Tashkilot</label>
                <select id="organization" name="organization" class="form-select">
                  <option value="">Tanlang...</option>
                  {% for org in organizations %}
                    <option value="{{ org.id }}"
                      {% if selected_org == org.id|stringformat:"s" %}selected{% endif %}>
                      {{ org.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-3">
                <label for="department" class="form-label">Department</label>
                <select id="department" name="department" class="form-select">
                  <option value="">Tanlang...</option>
                  {# agar siz departments ni hamma qilib yuborsangiz ko'p bo'ladi, lekin ajax bilan baribir yangilanadi #}
                  {% for dep in departments %}
                    <option value="{{ dep.id }}"
                      {% if selected_dep == dep.id|stringformat:"s" %}selected{% endif %}>
                      {{ dep.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-3">
                <label for="directorate" class="form-label">Boshqarma</label>
                <select id="directorate" name="directorate" class="form-select">
                  <option value="">Tanlang...</option>
                  {% for dir in directorates %}
                    <option value="{{ dir.id }}"
                      {% if selected_dir == dir.id|stringformat:"s" %}selected{% endif %}>
                      {{ dir.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-3">
                <label for="division" class="form-label">Bo‘lim</label>
                <select id="division" name="division" class="form-select">
                  <option value="">Tanlang...</option>
                  {% for div in divisions %}
                    <option value="{{ div.id }}"
                      {% if selected_div == div.id|stringformat:"s" %}selected{% endif %}>
                      {{ div.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Qidirish</button>
              </div>

            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TABLE -->
  <section class="section dashboard">
    <div class="row">
      <div class="col-lg-12">

        <div class="card recent-sales overflow-auto">
          <div class="card-body">

            <h5 class="card-title">
              {% if category %}
                {{ category.name }} — <span class="text-muted">{{ total_count }} ta texnika</span>
              {% else %}
                Hammasi — <span class="text-muted">{{ total_count }} ta texnika</span>
              {% endif %}
            </h5>

            {# ❗ Datatable bo'lsa pagination bilan urishadi. Tavsiya: datatable class olib tashlang #}
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Lavozim</th>
                  <th>F.I.O</th>
                  <th>Texnika nomi</th>
                  <th>I/N</th>
                  <th>S/N</th>
                  <th>IP</th>
                  <th>MAC</th>
                  <th>YIL</th>
                </tr>
              </thead>

              <tbody>
                {% for emp, techs in grouped_technics %}
                  <tr>
                    {# ✅ bu endi sahifa bo'yicha xodim raqami (group) #}
                    <th scope="row">
                      {% if page_obj %}
                        {{ page_obj.start_index|add:forloop.counter0 }}
                      {% else %}
                        {{ forloop.counter }}
                      {% endif %}
                    </th>

                    <td>{{ emp.rank|default:"-" }}</td>

                    <td>
                      {% if emp and emp.user %}
                        {{ emp.full_name }}
                      {% elif emp %}
                        {{ emp.full_name }}
                      {% else %}
                        <span class="text-muted">— Biriktirilmagan —</span>
                      {% endif %}
                    </td>

                    <!-- TEXNIKA NOMI -->
                    <td>
                      {% for t in techs %}
                        {% if not category %}
                          {{ t.category }} ({{ t.name }})
                        {% else %}
                          {{ t.name }}
                        {% endif %}

                        {% for et in t.extratechnics_set.all %}
                          <br>{{ et.name }}
                        {% endfor %}

                        {% if not forloop.last %}
                          <hr class="my-1">
                        {% endif %}
                      {% endfor %}
                    </td>

                    <!-- INVENTAR -->
                    <td>
                      {% for t in techs %}
                        {{ t.inventory|default:"-" }}
                        {% for et in t.extratechnics_set.all %}
                          <br>{{ et.inventory|default:"-" }}
                        {% endfor %}
                        {% if not forloop.last %}<hr class="my-1">{% endif %}
                      {% endfor %}
                    </td>

                    <!-- SERIAL -->
                    <td>
                      {% for t in techs %}
                        {{ t.serial|default:"-" }}
                        {% for et in t.extratechnics_set.all %}
                          <br>{{ et.serial|default:"-" }}
                        {% endfor %}
                        {% if not forloop.last %}<hr class="my-1">{% endif %}
                      {% endfor %}
                    </td>

                    <!-- IP -->
                    <td>
                      {% for t in techs %}
                        {{ t.ip|default:"-" }}
                        {% for et in t.extratechnics_set.all %}
                          <br>{{ et.ip|default:"-" }}
                        {% endfor %}
                        {% if not forloop.last %}<hr class="my-1">{% endif %}
                      {% endfor %}
                    </td>

                    <!-- MAC -->
                    <td>
                      {% for t in techs %}
                        {{ t.mac|default:"-" }}
                        {% for et in t.extratechnics_set.all %}
                          <br>{{ et.mac|default:"-" }}
                        {% endfor %}
                        {% if not forloop.last %}<hr class="my-1">{% endif %}
                      {% endfor %}
                    </td>

                    <!-- YEAR -->
                    <td>
                      {% for t in techs %}
                        {{ t.year|default:"-" }}
                        {% for et in t.extratechnics_set.all %}
                          <br>{{ et.year|default:"-" }}
                        {% endfor %}
                        {% if not forloop.last %}<hr class="my-1">{% endif %}
                      {% endfor %}
                    </td>

                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="9" class="text-center text-muted">
                      Hech qanday texnika topilmadi.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>

            <!-- ✅ PAGINATION (100 ta xodim guruhi bo'yicha) -->
            {% if page_obj and page_obj.paginator.num_pages > 1 %}
              <nav class="mt-3">
                <ul class="pagination justify-content-center">

                  {% if page_obj.has_previous %}
                    <li class="page-item">
                      <a class="page-link"
                         href="?{% if qs_params %}{{ qs_params }}&{% endif %}page={{ page_obj.previous_page_number }}">«</a>
                    </li>
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">«</span></li>
                  {% endif %}

                  {# juda ko'p sahifa bo'lsa ham chiroyli: faqat yaqinlarini ko'rsatish #}
                  {% for p in page_obj.paginator.page_range %}
                    {% if p == page_obj.number %}
                      <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                    {% elif p >= page_obj.number|add:-2 and p <= page_obj.number|add:2 %}
                      <li class="page-item">
                        <a class="page-link"
                           href="?{% if qs_params %}{{ qs_params }}&{% endif %}page={{ p }}">{{ p }}</a>
                      </li>
                    {% endif %}
                  {% endfor %}

                  {% if page_obj.has_next %}
                    <li class="page-item">
                      <a class="page-link"
                         href="?{% if qs_params %}{{ qs_params }}&{% endif %}page={{ page_obj.next_page_number }}">»</a>
                    </li>
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">»</span></li>
                  {% endif %}

                </ul>
              </nav>
            {% endif %}

          </div>
        </div>

      </div>
    </div>
  </section>

</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {

  function loadDepartments(orgId, selectedDepId = null) {
    $('#department').html('<option value="">Yuklanmoqda...</option>');
    $('#directorate').html('<option value="">Tanlang...</option>');
    $('#division').html('<option value="">Tanlang...</option>');

    if (orgId) {
      $.ajax({
        url: "{% url 'ajax_load_departments' %}",
        data: { 'organization': orgId },
        success: function (data) {
          let options = '<option value="">Tanlang...</option>';
          $.each(data, function (i, dep) {
            let selected = (String(selectedDepId) === String(dep.id)) ? 'selected' : '';
            options += `<option value="${dep.id}" ${selected}>${dep.name}</option>`;
          });
          $('#department').html(options);
        }
      });
    } else {
      $('#department').html('<option value="">Tanlang...</option>');
    }
  }

  function loadDirectorate(depId, selectedDirId = null) {
    $('#directorate').html('<option value="">Yuklanmoqda...</option>');
    $('#division').html('<option value="">Tanlang...</option>');

    if (depId) {
      $.ajax({
        url: "{% url 'ajax_load_directorate' %}",
        data: { 'department': depId },
        success: function (data) {
          let options = '<option value="">Tanlang...</option>';
          $.each(data, function (i, dir) {
            let selected = (String(selectedDirId) === String(dir.id)) ? 'selected' : '';
            options += `<option value="${dir.id}" ${selected}>${dir.name}</option>`;
          });
          $('#directorate').html(options);
        }
      });
    } else {
      $('#directorate').html('<option value="">Tanlang...</option>');
    }
  }

  function loadDivision(dirId, selectedDivId = null) {
    $('#division').html('<option value="">Yuklanmoqda...</option>');

    if (dirId) {
      $.ajax({
        url: "{% url 'ajax_load_division' %}",
        data: { 'directorate': dirId },
        success: function (data) {
          let options = '<option value="">Tanlang...</option>';
          $.each(data, function (i, div) {
            let selected = (String(selectedDivId) === String(div.id)) ? 'selected' : '';
            options += `<option value="${div.id}" ${selected}>${div.name}</option>`;
          });
          $('#division').html(options);
        }
      });
    } else {
      $('#division').html('<option value="">Tanlang...</option>');
    }
  }

  $('#organization').change(function () { loadDepartments($(this).val()); });
  $('#department').change(function () { loadDirectorate($(this).val()); });
  $('#directorate').change(function () { loadDivision($(this).val()); });

  // oldingi tanlanganlarni tiklash
  let initialOrg = '{{ selected_org }}';
  let initialDep = '{{ selected_dep }}';
  let initialDir = '{{ selected_dir }}';
  let initialDiv = '{{ selected_div }}';

  if (initialOrg) {
    $('#organization').val(initialOrg);
    loadDepartments(initialOrg, initialDep);

    if (initialDep) {
      loadDirectorate(initialDep, initialDir);

      if (initialDir) {
        loadDivision(initialDir, initialDiv);
      }
    }
  }
});
</script>

{% endblock content %}
